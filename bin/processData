#!/bin/sh
#
# David Adams
# June 2018
#
#
# Script to process event data and create calibration histograms.

makeFcl() {
  FCLNAME=$1
  FCLFILE=$FCLNAME.fcl
  if [ -r $FCLFILE ]; then
    echo makeFcl: File already exists: $FCLFILE
    return 2
  fi
  if [ ${FCLNAME:0:4} = femb ]; then
    NUM=${FCLNAME:4}
    while [ ${NUM:0:1} = 0 -a ${#NUM} -gt 1 ]; do NUM=${NUM:1}; done
    echo "physics.producers.dataprep.KeepFembs: [$NUM]" >$FCLFILE
  elif [ ${FCLNAME:0:4} = chan ]; then
    NUM=${FCLNAME:4}
    while [ ${NUM:0:1} = 0 -a ${#NUM} -gt 1 ]; do NUM=${NUM:1}; done
    echo "physics.producers.dataprep.KeepChannelBegin: $NUM" >$FCLFILE
    echo "physics.producers.dataprep.KeepChannelEnd: $((NUM+1))" >>$FCLFILE
  elif [ ${FCLNAME:0:2} = wf -a ${#FCLNAME} -gt 2 ]; then
    NUM1=${FCLNAME:2}
    while [ ${NUM1:0:1} = 0 -a ${#NUM1} -gt 1 ]; do NUM1=${NUM1:1}; done
    NUM2=$((NUM1+1000))
    echo '#include "wf.fcl"' >$FCLFILE
    echo "tools.adcPlotRaw.PlotSamMin: $NUM1" >>$FCLFILE
    echo "tools.adcPlotRaw.PlotSamMax: $NUM2" >>$FCLFILE
  elif [ ${FCLNAME:0:4} = trig ]; then
    NUM=${FCLNAME:4}
    while [ ${NUM:0:1} = 0 -a ${#NUM} -gt 1 ]; do NUM=${NUM:1}; done
    echo "physics.filters.trigfilter.TimingFlagSelectList: [$NUM]" >$FCLFILE
  elif [ ${FCLNAME:0:5} = event ]; then
    RAN=${FCLNAME:5}  # I or I-J
    NUM1=${RAN%%-*}
    if [ $NUM1 = $RAN ]; then
      NUM2=$((NUM1+1))
    else
      NUM2=${RAN##*-}
    fi
    while [ ${NUM1:0:1} = 0 -a ${#NUM1} -gt 1 ]; do NUM1=${NUM1:1}; done
    while [ ${NUM2:0:1} = 0 -a ${#NUM2} -gt 1 ]; do NUM2=${NUM2:1}; done
    echo "physics.filters.eventfilter.EventBegin: $NUM1" >$FCLFILE
    echo "physics.filters.eventfilter.EventEnd: $NUM2" >>$FCLFILE
  fi
  if [ ! -r $FCLFILE ]; then
    echo makeFcl: Unable to create $FCLFILE
    return 1
  fi
  echo makeFcl: Created $FCLFILE
}

RUNS="1194 1195 1193 1197 1192 1198 1203"
IRUN=1185
FCLPATH=run
NEVT=1
NSKP=0
OUTPUT=0
#RUN=run001191
if [ -n "$1" ]; then
  FCLPATH=$1
fi
if [ -n "$3" ]; then
  NEVT=$3
fi
if [ -n "$4" ]; then
  NSKP=$4
fi
if [ -n "$2" ]; then
  if [ $2 == all ]; then
    for RUN in $RUNS; do
      $0 $FCLPATH $RUN $NEVT $NSKIP
    done
  fi
  IRUN=$2
else
  echo Usage: $0 FCL RUN [NEVT] [NSKIP]
  exit 0
fi
if [ -n "$5" ]; then
  OUTPUT=1
fi
FRUN=$IRUN
while [ ${#FRUN} -lt 6 ]; do FRUN=0$FRUN; done
RUNNAME=run$FRUN

DIR=`echo ${FCLPATH}/$RUNNAME | sed 's#:#/#g'`
echo Run directory: $DIR
rm -rf $DIR
mkdir -p $DIR
cd $DIR

INSPEC=
INFILELIST=$HOME/data/dune/np04/np04_cryostat_commissioning/np04_run${FRUN}_files.txt
if [ -r $INFILELIST ]; then
  echo Taking input files from $INFILELIST
  INSPEC="-S $INFILELIST"
else
  echo Did not find file list $INFILELIST
  echo Searching directly for files...
  INDIRS="$HOME/data/dune/np04/*"
  echo Searching for matching files in $INDIRS
  INNAMES="np04_raw_${RUNNAME}_1_dl1.root np04_raw_${RUNNAME}_0001_dl1.root"
  INFILES=
  for INDIR in $INDIRS; do
    for INFILE in $INDIR/np04_raw_${RUNNAME}_*_dl?.root; do
      if [ -r $INFILE ]; then
        INFILES="$INFILES $INFILE"
      fi
    done
  done
  if [ -z "$INFILES" ]; then
    echo "Input data file(s) not found:"
    for INNAME in $INNAMES; do
      echo "  $INNAME"
    done
    exit 1
  fi
  echo "Input file(s):"
  for INFILE in $INFILES; do
    echo "  $INFILE"
  done
  INSPEC="-s $INFILES"
fi

touch run.fcl
for NAME in `echo $FCLPATH | sed 's#/# #g'`; do
  if ! fcldump $NAME.fcl 2>&1 1>/dev/null; then 
    if ! makeFcl $NAME; then
      echo FCL not found: $NAME.fcl
      exit 2
    fi
  fi
  echo "#include \"$NAME.fcl\"" >>run.fcl
done
FCLFILE=run.fcl

FW_SEARCH_PATH="..:$FW_SEARCH_PATH"
FHICL_FILE_PATH=".:..:../../run:$FHICL_FILE_PATH"
if true; then
  if ! fcldump $FCLFILE 5 >${FCLFILE}dump 2>fcldumperr.txt; then
    echo Ignoring fcldump errors.
  fi
else
  if ! fcldump $FCLFILE 5 >${FCLFILE}dump; then
    exit 3
  fi
fi
if [ $OUTPUT -eq 1 ]; then
  echo "lar -c $FCLFILE $INSPEC -n $NEVT --nskip $NSKP" >run
else
  echo "lar -c $FCLFILE $INSPEC -n $NEVT --nskip $NSKP --no-output" >run
fi
chmod +x run
if [ $IRUN != '0' ]; then
  ./run 2>&1 | tee run.log
  STAT=$?
  if [ $STAT -ne 0 ]; then
    echo "Job failed with error $STAT"
  else
    echo "Job succeeded."
  fi
fi
echo Run directory: $DIR
echo ARGS: '-c' $FCLFILE '-s' $INFILES '-n' $NEVT '--nskip' $NSKP
echo Command: `cat run`
